---
title: "p8105_hw6_NL2836"
author: "Ngan Le"
date: "2023-12-01"
output: github_document
---

```{r setup, message = FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
```

# Question 1

##### Import dataset from CSV file. 

```{r import homicide data, message = FALSE}
homicide = read_csv("homicide-data.csv") %>% 
  janitor::clean_names()
```

_This dataset includes `r nrow(homicide)` observations and `r ncol(homicide)` variables, reporting the date, the city, the state, the coordinates of the incidences, the victims' name, age, race, gender, and the disposition of the case. The incidences are reported across `r n_distinct(homicide$state)` states from 2007-2017._

##### Create a city_state variable (e.g. “Baltimore, MD”), and a binary variable indicating whether the homicide is solved. Omit cities Dallas, TX; Phoenix, AZ; and Kansas City, MO – these don’t report victim race. Also omit Tulsa, AL – this is a data entry mistake. For this problem, limit your analysis those for whom victim_race is white or black. Be sure that victim_age is numeric.

```{r create city_state & binary homicide vars, warning = FALSE}
cleaned_homicide =
  homicide %>%
  mutate(city_state = str_c(city, ", ", state)) %>% 
  mutate(solved = ifelse(disposition %in% c("Closed by arrest","Closed without arrest"), 1, 0)) %>%
  filter(!city_state %in% c("Dallas, TX", "Phoenix, AZ", "Kansas City, MO", "Tulsa, AL")) %>%
  filter(victim_race %in% c("White", "Black")) %>%
  mutate(victim_age = ifelse(victim_age == "unknown", NA, victim_age)) %>%
  mutate(victim_age = as.numeric(victim_age))

cleaned_homicide
```

##### For the city of Baltimore, MD, use the glm function to fit a logistic regression with resolved vs unresolved as the outcome and victim age, sex and race as predictors. Save the output of glm as an R object; apply the broom::tidy to this object; and obtain the estimate and confidence interval of the adjusted odds ratio for solving homicides comparing male victims to female victims keeping all other variables fixed.


```{r baltimore glm}
baltimore_glm =
  cleaned_homicide %>%
  filter(city_state == "Baltimore, MD") %>%
  glm(solved ~ victim_age + victim_sex + victim_race, 
             data =., 
             family = binomial) %>% 
  broom::tidy(baltimore_glm, 
              exponentiate = TRUE, 
              conf.int = TRUE, 
              conf.level = 0.95) %>% 
  rename(OR = estimate, 
         CI_lower = conf.low, 
         CI_upper = conf.high,
         p_value = p.value) %>%
  mutate(p_value = ifelse(p_value < 0.05, "<0.05", as.character(round(p_value, 3)))) %>%
  select(term, OR, CI_lower, CI_upper, p_value) %>% 
  knitr::kable(digits = 3)

baltimore_glm
```

_With the `female` being the reference category for sex and `Black` being the reference category for race: the odds of having the homicide case solved among male victims is 0.355 times the odds of having homicide case solved among female victims. Since the p-value is smaller than 0.05, we have sufficient evidence to claim that the odds of having the homicide case solved are significantly different between male and female victims._

```{r cities_glm, warning = FALSE}
cities_glm <- cleaned_homicide %>% 
  group_by(city_state) %>%
  nest() %>%
  mutate(
    regression = map(data, ~glm(formula = solved ~ victim_age + victim_sex + victim_race, data = ., family = binomial())),
    solved_cities = map(regression, ~broom::tidy(.x, exponentiate = TRUE, conf.int = TRUE, conf.level = 0.95))
  ) %>% 
  select(-data, -regression) %>% 
  unnest(solved_cities) %>% 
  filter(term == "victim_sexMale") %>% 
  rename(OR = estimate, 
         CI_lower = conf.low, 
         CI_upper = conf.high,
         p_value = p.value) %>% 
  select(city_state, OR, CI_lower, CI_upper) 

cities_glm
```
# MISSING DESCRIPTION

##### Create a plot that shows the estimated ORs and CIs for each city. Organize cities according to estimated OR, and comment on the plot.


```{r, dpi = 300}
OR_plot = 
  ggplot(cities_glm, aes(x = reorder(city_state, OR), y = OR)) +
  geom_point() +
  geom_errorbar(aes(ymin = CI_lower, ymax = CI_upper)) +
  coord_flip() +
  labs(x = "City", y = "Odds Ratio (OR)", 
       title = "Estimated ORs and CIs for Solving Homicides in Each City") +
  theme_minimal()

OR_plot
```



